version: 2.1


jobs:
  create_infrastructure: # Job for lab01
    docker:
      - image: amazon/aws-cli

    steps:
      - checkout
      - run:
          name: create ec2 instance stack in cloudformation
          command: |
            aws cloudformation deploy --template-file project03/lab01/template.yml --stack-name websv01

  configure_infrastructure: # Job for lab02
    docker:
      - image: python:3.7-alpine3.11

    steps:
      - checkout
      - add_ssh_keys:
          fingerprints: ["4d:0b:29:64:e7:f8:19:f7:0a:76:80:38:8a:fe:be:b6"]
      
      - run:
          name: Install dependencies
          command: 
            apk add --update ansible

      - run:
          name: Configure Server
          command: |
            cd ./Project03/lab03/
            ansible-playbook -i inventory.txt playbook.yml 

workflows:
  Infrastructure_Workflow:
    jobs:
      #- create_infrastructure # lab01
      - configure_infrastructure #lab02
  